<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.2/ace.js
	"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700" rel="stylesheet">
	<style type="text/css">
		body {
			font-family: 'Roboto', sans-serif;
		}
		#query_editor_textarea, #query_includes_textarea {
			width: 100%;
			min-height: 400px;
			font-family: 'Roboto Mono', monospace;
		}
		#formatted_query {
			font-family: 'Roboto Mono', monospace;
		}
		#results_tabs {
			background-color: #f5f5f5;
		}
		.sidebar {
			background-color: #fff;
		}
		.example_snippet {
			font-size: small;
			background-color: #fff;
			border-radius: 5px;
			padding-left: 5px;
		}

		/* bootstrap overrides */
		.nav-pills .nav-link {
			border-radius: 0;
		}
		.nav-pills .nav-link.active {
			background-color: transparent;
			color: #0068d8;
			text-decoration: underline;
		}

	</style>
</head>
<body>
<nav class="navbar border-bottom">
  <a class="navbar-brand" href="/"><h2>#SQL</h2></a>
    <div class="form-inline">
    <button  id="query_editor_run_button" class="btn btn-primary my-2 my-sm-0 mr-2" type="submit">Run</button>
    <div class="btn-group">
  <button id="query_editor_options_button" type="button" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" data-display="static" aria-haspopup="true" aria-expanded="false">
    Options
  </button>
  <div class="dropdown-menu dropdown-menu-right mt-2">
    <button id="query_editor_save_button" class="dropdown-item" type="button">Save query</button>
    <button id="query_editor_open_button" class="dropdown-item" type="button">Open Query</button>
    <button id="query_editor_history_button" class="dropdown-item" type="button">Query History</button>
    <div class="dropdown-divider"></div>
    <button id="query_editor_history_button" class="dropdown-item" type="button">Settings</button>
  </div>
</div>
  </div>
</nav>
<main role="main" class="container-flex">
  <div class="row">
    <div class="col-2 sidebar">
    	<div class="mt-2 ml-2">
    	<h4>Editor</h4>
    	<div class="card card-body">
    	    <div class="nav flex-column nav-pills" id="nav-tab" role="tablist" aria-orientation="vertical">
      <a class="nav-link active" id="nav-query-editor-tab" data-toggle="pill" href="#nav-query-editor" role="tab" aria-controls="nav-query-editor" aria-selected="true">Query Editor</a>
      <a class="nav-link" id="nav-includes-tab" data-toggle="pill" href="#nav-includes" role="tab" aria-controls="nav-includes" aria-selected="false">Macros</a>
  </div>
    </div>
</div>

    	<div class="mt-2 ml-2">
<h4  class="dropdown-toggle" data-toggle="collapse" data-target="#reference-collapsible" aria-expanded="false" aria-controls="reference-collapsible">Reference</h4>

<div class="collapse" id="reference-collapsible">
  <div class="card card-body">
   <p>Define a macro according to the syntax below, and use a <code>${macro_name}</code> reference in your actual query to use the macro.</p>
<h5>Example</h5>
<div class="example_snippet">
<code>
	DEFINE MACRO your_macro:
		(create_date < NOW() AND is_in_date_range = TRUE);<br>
	SELECT x FROM y WHERE ${your_macro};
</code>
</div>
  </div>
</div>


    	</div>
    </div>
    <div class="col-sm-10 pl-0">

    	<div class="tab-content" id="nav-tabContent">
      <div class="tab-pane show active" id="nav-query-editor" role="tabpanel" aria-labelledby="nav-query-editor-tab">
      	<div id="query_editor_textarea"/></div>
      </div>
      <div class="tab-pane" id="nav-includes" role="tabpanel" aria-labelledby="nav-includes-tab">
      <div id="query_includes_textarea"/></div>
      </div>
    </div>


<ul class="nav nav-pills justify-content-center mt-2 p-2" id="results_tabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="results-tab" data-toggle="tab" href="#results" role="tab" aria-controls="results" aria-selected="true">Results</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="sql-tab" data-toggle="tab" href="#sql" role="tab" aria-controls="sql" aria-selected="false">SQL</a>
  </li>
</ul>
<div class="tab-content" id="myTabContent">
  <div class="tab-pane show active" id="results" role="tabpanel" aria-labelledby="results-tab">
  	<div id="query_results">
  	<center><span style="color:#898989;">Run a query to get results.</span></center>
  </div>
</div>
  <div class="tab-pane" id="sql" role="tabpanel" aria-labelledby="sql-tab">
  	<div id="formatted_query">
  	<center><span style="color:#898989;">Run a query to see the SQL.</span></center>
  </div>
</div>
</div>

</main>


<script>
    var query_editor = ace.edit("query_editor_textarea")
	query_editor.setTheme("ace/theme/dreamweaver")
	query_editor.setOptions({fontSize: "12pt"})
	query_editor.getSession().setMode("ace/mode/sql")
	var query_editor_from_localstorage = localStorage.getItem('sql_query');
	query_editor.setValue(query_editor_from_localstorage == undefined || "" ? "" : query_editor_from_localstorage)


	query_editor.on("input", function(e) {
		localStorage.setItem('sql_query', query_editor.getValue())
	})

	window.onbeforeunload = function(){
	  localStorage.setItem('sql_query', query_editor.getValue())
	};

	var includes_editor = ace.edit("query_includes_textarea")
	includes_editor.setTheme("ace/theme/dreamweaver")
	includes_editor.setOptions({fontSize: "12pt"})
	includes_editor.getSession().setMode("ace/mode/sql")
	var includes_editor_from_localstorage = localStorage.getItem('sql_include');
	includes_editor.setValue(includes_editor_from_localstorage == undefined || "" ? "" : includes_editor_from_localstorage)


	includes_editor.on("input", function(e) {
		localStorage.setItem('sql_include', includes_editor.getValue())
	})

	window.onbeforeunload = function(){
	  localStorage.setItem('sql_include', includes_editor.getValue())
	};


	$("#query_editor_run_button").click(function(){
		$.post("/internal/format_query", {"raw_query": includes_editor.getValue() + "\n" + query_editor.getValue()}, function( results ) {
			$("#formatted_query").html(results.replace(/\n/g, "<br>"))
			$.post("/internal/run_query", {"formatted_query": results}, function( results ) {
				

				var results_table_html = `<table class="table">`

				$.each(JSON.parse(results), function(i, row) {
					if(i == 0) {
						results_table_html += `<thead><tr>`
						for (var key in row) {
						    if (row.hasOwnProperty(key)) {
						        results_table_html += `<th scope="col">` + key + `</th>`
						    }
						}
						    results_table_html += `</tr></thead>`
					} else {
						results_table_html += `<tr>`
						for (var key in row) {
						    if (row.hasOwnProperty(key)) {
						    	results_table_html += `<td>` + row[key] + `</td>`
						    }
						}
						results_table_html += `</tr>`
					}	
				})
				results_table_html += `</table>`
				console.log(results_table_html)
				$("#query_results").html(results_table_html)
			})
		})
	})
</script>
</body>
</html>